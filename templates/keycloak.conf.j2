server {
   listen 443 ssl http2;
   listen [::]:443 ssl http2;
   server_name {{ app.name }};
   ssl_certificate {{ app.cert }};
   ssl_certificate_key {{ app.key }};
   {% if app.hsts %}add_header Strict-Transport-Security "max-age=31536000; includeSubdomains";{% endif %}

   access_log /var/log/nginx/{{ app.name }}-access;
   error_log /var/log/nginx/{{ app.name }}-error;

{% if app.ocsp_cert is defined %}
   ssl_stapling on;
   ssl_stapling_verify on;
   ssl_trusted_certificate {{ app.ocsp_cert }};
{% endif %}

   location / {
			return 301 https://$server_name/auth/realms/{{ app.keycloak_domain }}/account/ ;
	 }

   location /auth/admin {
      deny all;
   }

   location /auth {
      proxy_pass {{ app.upstream }};
      proxy_set_header HOST $server_name;
      proxy_set_header Referer $http_referer;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Content-Type-Options nosniff;
   }
}

server {
    listen      80;
    listen      [::]:80;
    server_name {{ app.name }};
    rewrite     ^   https://$server_name$request_uri? permanent;
}
